<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-commerce Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { overflow-x: hidden; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0f1117;
      color: #e2e8f0;
      min-height: 100vh;
      overflow-x: hidden;
      max-width: 100vw;
    }

    .top-bar {
      position: sticky;
      top: 0;
      z-index: 100;
      width: 100%;
    }

    header {
      background: #1a1d27;
      border-bottom: 1px solid #2d3148;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    header h1 { font-size: 1.1rem; font-weight: 700; color: #fff; }
    header span { font-size: 0.75rem; color: #6b7280; }

    nav {
      background: #1a1d27;
      border-bottom: 1px solid #2d3148;
      padding: 0 1.5rem;
      display: flex;
      gap: 0;
      overflow-x: auto;
      scrollbar-width: none;
    }

    nav::-webkit-scrollbar { display: none; }

    nav button {
      background: none;
      border: none;
      color: #6b7280;
      padding: 0.875rem 1rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }

    nav button:hover { color: #e2e8f0; }
    nav button.active { color: #6366f1; border-bottom-color: #6366f1; }

    main { padding: 1.25rem; max-width: 1400px; margin: 0 auto; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    @media (min-width: 640px) {
      .kpi-grid { grid-template-columns: repeat(4, 1fr); }
    }

    .kpi-card {
      background: #1a1d27;
      border: 1px solid #2d3148;
      border-radius: 10px;
      padding: 1rem 1.25rem;
    }

    .kpi-card .label { font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4rem; }
    .kpi-card .value { font-size: 1.4rem; font-weight: 700; color: #fff; }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    @media (min-width: 900px) {
      .charts-grid.two-col { grid-template-columns: 1fr 1fr; }
    }

    .chart-card {
      background: #1a1d27;
      border: 1px solid #2d3148;
      border-radius: 10px;
      padding: 1.25rem;
    }

    .chart-card h3 {
      font-size: 0.7rem;
      font-weight: 600;
      color: #a0aec0;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .chart-wrap { position: relative; height: 240px; width: 100%; }

    @media (min-width: 640px) {
      .chart-wrap { height: 280px; }
    }

    canvas { display: block; max-width: 100%; }

    .chart-card { min-width: 0; }

    .table-wrap { overflow-x: auto; margin-top: 0.5rem; -webkit-overflow-scrolling: touch; max-width: 100%; }

    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 400px; }
    thead th { text-align: left; padding: 0.5rem 0.75rem; color: #6b7280; font-weight: 500; border-bottom: 1px solid #2d3148; font-size: 0.7rem; text-transform: uppercase; white-space: nowrap; }
    tbody td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #1e2130; color: #e2e8f0; }
    tbody tr:hover { background: #1e2130; }
    tbody tr:last-child td { border-bottom: none; }

    .loading { color: #4b5563; font-size: 0.875rem; padding: 2rem; text-align: center; }

    .chart-note { font-size: 0.65rem; color: #4b5563; margin-top: -0.6rem; margin-bottom: 0.85rem; line-height: 1.4; }

    #table-retention { min-width: 500px; font-size: 0.72rem; }
    #table-retention th, #table-retention td { padding: 0.3rem 0.5rem; }

    @media (max-width: 640px) {
      main { padding: 1rem 0.75rem; }
      .kpi-card .value { font-size: 1.2rem; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <header>
    <h1>E-commerce Analytics</h1>
    <span>Transactional &amp; Behavioral Data Layer</span>
  </header>

  <nav>
    <button class="active" onclick="switchTab('revenue', this)">Revenue KPIs</button>
    <button onclick="switchTab('cohorts', this)">Cohort Analysis</button>
    <button onclick="switchTab('demand', this)">Demand Indicators</button>
  </nav>
</div>

<main>

  <div id="tab-revenue" class="tab-content active">
    <div class="kpi-grid">
      <div class="kpi-card"><div class="label">Total Revenue</div><div class="value" id="kpi-revenue">—</div></div>
      <div class="kpi-card"><div class="label">Total Orders</div><div class="value" id="kpi-orders">—</div></div>
      <div class="kpi-card"><div class="label">Avg Order Value</div><div class="value" id="kpi-aov">—</div></div>
      <div class="kpi-card"><div class="label">Completion Rate</div><div class="value" id="kpi-completion">—</div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Monthly Revenue (€)</h3>
        <div class="chart-wrap"><canvas id="chart-monthly-revenue"></canvas></div>
      </div>
    </div>
    <div class="charts-grid two-col">
      <div class="chart-card">
        <h3>Monthly Orders (count)</h3>
        <div class="chart-wrap"><canvas id="chart-monthly-orders"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Conversion Rate by Source (%)</h3>
        <div class="chart-wrap"><canvas id="chart-conversion"></canvas></div>
      </div>
    </div>
  </div>

  <div id="tab-cohorts" class="tab-content">
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Repeat Purchase Rate (%)</h3>
        <p class="chart-note">Share of customers who made at least one additional purchase, by acquisition month</p>
        <div class="chart-wrap"><canvas id="chart-repeat"></canvas></div>
      </div>
    </div>
    <div class="chart-card">
      <h3>Customer Retention by Cohort</h3>
      <p class="chart-note">% of buyers from each month who returned to purchase again — columns show how many months after their first order</p>
      <div class="table-wrap">
        <table id="table-retention">
          <thead><tr></tr></thead>
          <tbody><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-demand" class="tab-content">
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Monthly Revenue Growth Rate (%)</h3>
        <div class="chart-wrap"><canvas id="chart-growth"></canvas></div>
      </div>
    </div>
    <div class="charts-grid two-col">
      <div class="chart-card">
        <h3>Top 20 Products by Units Sold</h3>
        <div class="table-wrap">
          <table id="table-top-products">
            <thead><tr><th>Product</th><th>Category</th><th>Units</th><th>Revenue</th></tr></thead>
            <tbody><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="chart-card">
        <h3>Units Sold by Category</h3>
        <div class="chart-wrap"><canvas id="chart-category"></canvas></div>
      </div>
    </div>
  </div>

</main>

<script>
const API = '';
const COLORS = ['#5470c6','#91cc75','#fac858','#ee6666','#73c0de','#3ba272','#fc8452','#9a60b4'];
const CAT_COLORS = ['#5470c6','#91cc75','#fac858','#ee6666','#73c0de','#3ba272','#fc8452','#9a60b4'];

function switchTab(name, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
}

function fmt(n) { return new Intl.NumberFormat('en-US').format(Math.round(n)); }
function fmtEur(n) { return '€' + fmt(n); }

function makeChart(id, type, labels, datasets, extra = {}) {
  const ctx = document.getElementById(id).getContext('2d');
  const { plugins: extraPlugins = {}, scales: extraScales = {}, ...restExtra } = extra;
  return new Chart(ctx, {
    type,
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        ...extraPlugins
      },
      scales: type !== 'pie' && type !== 'doughnut' ? {
        x: { ticks: { color: '#6b7280', maxRotation: 45, font: { size: 9 } }, grid: { color: '#1e2130' } },
        y: { ticks: { color: '#6b7280', font: { size: 9 } }, grid: { color: '#1e2130' } },
        ...extraScales
      } : {},
      ...restExtra
    }
  });
}

async function loadRevenue() {
  const [summary, monthly, conversion] = await Promise.all([
    fetch(API + '/kpi/summary').then(r => r.json()),
    fetch(API + '/kpi/revenue').then(r => r.json()),
    fetch(API + '/kpi/conversion').then(r => r.json()),
  ]);

  document.getElementById('kpi-revenue').textContent = fmtEur(summary.total_revenue);
  document.getElementById('kpi-orders').textContent = fmt(summary.total_orders);
  document.getElementById('kpi-aov').textContent = fmtEur(summary.avg_order_value);
  document.getElementById('kpi-completion').textContent = summary.completion_rate_pct + '%';

  makeChart('chart-monthly-revenue', 'bar',
    monthly.map(r => r.month),
    [{ data: monthly.map(r => r.total_revenue), backgroundColor: '#5470c6', borderRadius: 4 }]
  );
  makeChart('chart-monthly-orders', 'bar',
    monthly.map(r => r.month),
    [{ data: monthly.map(r => r.order_count), backgroundColor: '#73c0de', borderRadius: 4 }]
  );
  makeChart('chart-conversion', 'bar',
    conversion.map(r => r.source),
    [{ data: conversion.map(r => r.conversion_rate_pct), backgroundColor: COLORS, borderRadius: 4 }]
  );
}

async function loadCohorts() {
  const [retention, repeat] = await Promise.all([
    fetch(API + '/cohorts/retention').then(r => r.json()),
    fetch(API + '/cohorts/repeat-purchase').then(r => r.json()),
  ]);

  const cohorts = [...new Set(retention.map(r => r.cohort_month))].sort();
  const periods = [...new Set(retention.map(r => r.period_number))]
    .filter(p => p > 0).sort((a, b) => a - b).slice(0, 12);
  const map = {};
  retention.forEach(r => {
    if (!map[r.cohort_month]) map[r.cohort_month] = { size: r.cohort_size, p: {} };
    map[r.cohort_month].p[r.period_number] = r.retention_rate_pct;
  });

  document.querySelector('#table-retention thead tr').innerHTML =
    '<th>Acquisition month</th><th>Buyers</th>' + periods.map(p => `<th>+${p}m</th>`).join('');

  document.querySelector('#table-retention tbody').innerHTML = cohorts.map(cohort => {
    const d = map[cohort] || { size: 0, p: {} };
    const cells = periods.map(p => {
      const v = d.p[p];
      if (v === undefined) return '<td style="color:#374151">—</td>';
      const hue = Math.min(Math.round(v * 2.4), 120);
      return `<td style="color:hsl(${hue},60%,60%)">${v}%</td>`;
    }).join('');
    return `<tr><td>${cohort}</td><td>${fmt(d.size)}</td>${cells}</tr>`;
  }).join('');

  makeChart('chart-repeat', 'line',
    repeat.map(r => r.cohort_month),
    [{ data: repeat.map(r => r.repeat_rate_pct), borderColor: '#9a60b4', backgroundColor: 'rgba(154,96,180,0.1)', fill: true, tension: 0.4, pointRadius: 3 }]
  );
}

async function loadDemand() {
  const [growth, topProducts, byCategory] = await Promise.all([
    fetch(API + '/demand/growth').then(r => r.json()),
    fetch(API + '/demand/top-products').then(r => r.json()),
    fetch(API + '/demand/by-category').then(r => r.json()),
  ]);

  makeChart('chart-growth', 'bar',
    growth.map(r => r.month),
    [{ data: growth.map(r => r.growth_rate_pct), backgroundColor: growth.map(r => r.growth_rate_pct >= 0 ? '#3ba272' : '#ee6666'), borderRadius: 4 }]
  );

  document.querySelector('#table-top-products tbody').innerHTML = topProducts.map(r => `
    <tr><td>${r.product_name}</td><td>${r.category_name}</td><td>${fmt(r.total_units)}</td><td>${fmtEur(r.total_revenue)}</td></tr>
  `).join('');

  const months = [...new Set(byCategory.map(r => r.month))].sort();
  const cats = [...new Set(byCategory.map(r => r.category_name))];
  makeChart('chart-category', 'bar', months,
    cats.map((cat, i) => ({
      label: cat,
      data: months.map(m => { const row = byCategory.find(r => r.month === m && r.category_name === cat); return row ? row.units_sold : 0; }),
      backgroundColor: CAT_COLORS[i % CAT_COLORS.length],
      borderRadius: 0,
    })),
    {
      plugins: { legend: { display: true, labels: { color: '#9ca3af', font: { size: 9 }, boxWidth: 8, padding: 6 } } },
      scales: { x: { stacked: true }, y: { stacked: true } }
    }
  );
}

loadRevenue();
document.querySelector('[onclick*="cohorts"]').addEventListener('click', loadCohorts, { once: true });
document.querySelector('[onclick*="demand"]').addEventListener('click', loadDemand, { once: true });
</script>

</body>
</html>
